{% extends "Users/layout.html" %}
{% load crispy_forms_tags %}

{% block body %}
    {% if request.user.is_patient %}
    <h6>Doctor : {{ Treatment.Doctor }}</h6>
    {% else %}
    <h6>Patient : {{ Treatment.Patient }}</h6>
    {% endif %}
    <h6>Disease : {{ Treatment.Disease }}</h6>

    <br>
    <h3>Symptoms</h3>
    <ul>
    {% for sym in Treatment.SymptomList.all %}
        <li>{{ sym.Name }}</li>
    {% endfor %}
    </ul>
    <br>
    {% if files %}
        <h3>Reports</h3>
        {% for file in files %}
            Name: <a href="{{ MEDIA_URL }}{{ file.filepath }}" target="_blank">{{ file.name }}</a>
            <p>Description : {{file.Description}}</p>
        {% endfor %}
    {% else%}
        <h5> No Reports Shared</h5>
    {% endif %}

    <h3>Appointments</h3>
    
    <h3>Prescription</h3>
    
    {% if request.user.is_patient %}
    <h6>{{ Treatment.Prescription }}</h6>
    {% else %}
        <div id="Presc">
            {% if Treatment.Prescription %}
            {{ Treatment.Prescription }}
            {% else %}
            <h4>No Prescription</h4>
            {% endif %}
            <br>
            <button id="Pbtn" data-val="{{ Treatment.id }}" class="btn btn-primary">Edit</button>
        </div>
    {% endif %}


    <br><br><br>
    <hr>
    {% for question in Treatment.Questions.all %}
            Question : {{ question.Question }} <br><br>
            {% if question.Is_Answered %}
                Reply : {{ question.Answer }}<br><br>
                {% if  question.Made_By == user %}
                    <a class="btn btn-primary" href="{% url 'delete_Question' question.id %}">Delete Question</a>
                    <br>
                {% endif %}
            {% else %}
                {% if  question.Made_By != user %}

                    <form action="{% url 'Add_Answer' Treatment.id question.id %}" method="POST">
                        {% csrf_token %}
                        {{A_Form | crispy}}
                        <input type="submit" value="Add Question" class="btn btn-primary">
                    </form>
                {% endif %}
                
            {% endif %}
            <hr>
            <br>
    {% endfor %}

    <br>
    <form action="{% url 'Add_Question' Treatment.id %}" method="POST">
        {% csrf_token %}
        {{Q_Form | crispy}}
        <input type="submit" value="Add Question" class="btn btn-primary">
    </form>

    <br><br><br>
    {% if request.user.is_patient and Treatment.is_completed %}
        <form method="post" action="{% url 'Delete_Treatment' Treatment.id%}">
            {% csrf_token %}
            <button type="submit" class="btn btn-primary">Delete Treatment</button>
        </form>    
    {% endif %}

    {% if request.user.is_doctor %}
        {% if not Treatment.is_completed %}
            <form method="post" action="{% url 'Complete_Treatment' Treatment.id %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-primary">Treatment Completed</button>
            </form>
        {% endif %}
    {% endif %}

    <script>
        document.addEventListener("DOMContentLoaded", function(){

            function EditPresc(id){               
            fetch(`/edit_Presc/${id}`)
            .then(response => response.text())
            .then(data => {
                document.querySelector('#Presc').innerHTML = data
            })
            return false
        }

            document.querySelector("#Pbtn").addEventListener('click', function(event){
                // event.preventDefault()
                id = this.dataset.val
                console.log(id)
                EditPresc(id)
            })
        })
    </script>
{% endblock %}